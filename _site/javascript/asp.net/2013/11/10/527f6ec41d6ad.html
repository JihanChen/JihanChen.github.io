<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>ASP.NET MVC应用require.js实践</title>
	
	<meta name="description" content="本文探讨如何在ASP.NET MVC多页面环境下应用js的模块化编程框架require，并给出压缩相关的自动化脚本">
	
	<meta name="author" content="JihanChen">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/typo/typo.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css?v=1.1" rel="stylesheet">

	<!-- Le fav and touch icons -->
	
	<link rel="icon" href="/favicon.ico" type="image/x-icon">
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	<!-- Update these with your own images
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/rss.xml">

	<!-- <script src="http://cdn.bootcss.com/jquery/1.8.2/jquery.min.js"></script> -->
	<script src="http://cdn.bootcss.com/jquery/1.10.1/jquery.min.js"></script>
</head>

<body>
 	<nav class="navbar-default visible-xs">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
		</div>

		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li><a href="/">首页</a></li>
				<li><a href="/category.html">分类</a></li>
				<li><a href="/tag.html">标签</a></li>
				<li><a href="/series.html">系列文章</a></li>
			</ul>
		</div>
	</nav>

	<div id="left-side" class="col-sm-3 sidebar hidden-xs">
		<!-- 
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="http://www.gravatar.com/avatar/?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/"></a>
    </h3>
</header> -->


<div id="bio" class="text-center">
	Do not build on quicksand high
</div>


<div class='navigator text-center'>
	<a href='/index.html' title='首页'>&#xf012b;</a>
	<a href='/rss.xml' title='RSS订阅'>&#xf01bc;</a>
	<!-- <a href='/me.html' title='关于我'>&#xf00cc;</a> -->
	<a href='/series.html' title='系列文章'>&#xf0161;</a>
</div>

<div class='category'>
	<ul>
		
			<li><a href="/category.html#life">life<span>5</span></a></li>
		
			<li><a href="/category.html#web-build">web-build<span>13</span></a></li>
		
			<li><a href="/category.html#resource">resource<span>3</span></a></li>
		
			<li><a href="/category.html#network">network<span>7</span></a></li>
		
			<li><a href="/category.html#C-Cpp">C-Cpp<span>6</span></a></li>
		
			<li><a href="/category.html#Linux">Linux<span>1</span></a></li>
		
			<li><a href="/category.html#Hardware">Hardware<span>1</span></a></li>
		
			<li><a href="/category.html#BMC">BMC<span>8</span></a></li>
		
			<li><a href="/category.html#Web">Web<span>5</span></a></li>
		
			<li><a href="/category.html#algorithm">algorithm<span>2</span></a></li>
		
			<li><a href="/category.html#hardware">hardware<span>9</span></a></li>
		
			<li><a href="/category.html#javascript">javascript<span>5</span></a></li>
		
			<li><a href="/category.html#asp.net">asp.net<span>1</span></a></li>
		
			<li><a href="/category.html#open-source">open-source<span>12</span></a></li>
		
			<li><a href="/category.html#web">web<span>3</span></a></li>
		
			<li><a href="/category.html#c-cpp">c-cpp<span>3</span></a></li>
		
			<li><a href="/category.html#IOS">IOS<span>3</span></a></li>
		
			<li><a href="/category.html#linux">linux<span>3</span></a></li>
		
	</ul>
</div>

<div class='tags'>
	
		<a href="/tag.html#github-page" style='font-size:43px;'>github-page</a>
	
		<a href="/tag.html#jekyll" style='font-size:33px;'>jekyll</a>
	
		<a href="/tag.html#liquid" style='font-size:21px;'>liquid</a>
	
		<a href="/tag.html#Git" style='font-size:23px;'>Git</a>
	
		<a href="/tag.html#Ruby" style='font-size:19px;'>Ruby</a>
	
		<a href="/tag.html#Linux" style='font-size:21px;'>Linux</a>
	
		<a href="/tag.html#SEO" style='font-size:17px;'>SEO</a>
	
		<a href="/tag.html#FTP" style='font-size:17px;'>FTP</a>
	
		<a href="/tag.html#NAT" style='font-size:17px;'>NAT</a>
	
		<a href="/tag.html#CPP" style='font-size:29px;'>CPP</a>
	
		<a href="/tag.html#dot NET" style='font-size:21px;'>dot NET</a>
	
		<a href="/tag.html#Compiler" style='font-size:21px;'>Compiler</a>
	
		<a href="/tag.html#Hardware" style='font-size:23px;'>Hardware</a>
	
		<a href="/tag.html#Performance" style='font-size:21px;'>Performance</a>
	
		<a href="/tag.html#BMC" style='font-size:27px;'>BMC</a>
	
		<a href="/tag.html#Web dev" style='font-size:19px;'>Web dev</a>
	
		<a href="/tag.html#Remedy" style='font-size:29px;'>Remedy</a>
	
		<a href="/tag.html#ITSM" style='font-size:17px;'>ITSM</a>
	
		<a href="/tag.html#Mid-Tier" style='font-size:17px;'>Mid-Tier</a>
	
		<a href="/tag.html#SSO" style='font-size:17px;'>SSO</a>
	
		<a href="/tag.html#algorithm" style='font-size:17px;'>algorithm</a>
	
		<a href="/tag.html#web-build" style='font-size:19px;'>web-build</a>
	
		<a href="/tag.html#bootstrap" style='font-size:19px;'>bootstrap</a>
	
		<a href="/tag.html#PHP" style='font-size:19px;'>PHP</a>
	
		<a href="/tag.html#Esxi" style='font-size:17px;'>Esxi</a>
	
		<a href="/tag.html#iso" style='font-size:17px;'>iso</a>
	
		<a href="/tag.html#Driver" style='font-size:17px;'>Driver</a>
	
		<a href="/tag.html#database" style='font-size:19px;'>database</a>
	
		<a href="/tag.html#consistency" style='font-size:17px;'>consistency</a>
	
		<a href="/tag.html#require.js" style='font-size:17px;'>require.js</a>
	
		<a href="/tag.html#asp.net mvc" style='font-size:19px;'>asp.net mvc</a>
	
		<a href="/tag.html#node.js" style='font-size:19px;'>node.js</a>
	
		<a href="/tag.html#network" style='font-size:25px;'>network</a>
	
		<a href="/tag.html#switch" style='font-size:25px;'>switch</a>
	
		<a href="/tag.html#VLAN" style='font-size:19px;'>VLAN</a>
	
		<a href="/tag.html#Trunk" style='font-size:17px;'>Trunk</a>
	
		<a href="/tag.html#VTP" style='font-size:17px;'>VTP</a>
	
		<a href="/tag.html#STP" style='font-size:17px;'>STP</a>
	
		<a href="/tag.html#compiler" style='font-size:19px;'>compiler</a>
	
		<a href="/tag.html#yacc" style='font-size:17px;'>yacc</a>
	
		<a href="/tag.html#lex" style='font-size:17px;'>lex</a>
	
		<a href="/tag.html#life" style='font-size:19px;'>life</a>
	
		<a href="/tag.html#PVST" style='font-size:17px;'>PVST</a>
	
		<a href="/tag.html#FSD" style='font-size:17px;'>FSD</a>
	
		<a href="/tag.html#Programmer" style='font-size:17px;'>Programmer</a>
	
		<a href="/tag.html#PLY" style='font-size:17px;'>PLY</a>
	
		<a href="/tag.html#Python" style='font-size:17px;'>Python</a>
	
		<a href="/tag.html#Lex" style='font-size:17px;'>Lex</a>
	
		<a href="/tag.html#Yacc" style='font-size:17px;'>Yacc</a>
	
		<a href="/tag.html#grid" style='font-size:17px;'>grid</a>
	
		<a href="/tag.html#html5" style='font-size:17px;'>html5</a>
	
		<a href="/tag.html#video" style='font-size:17px;'>video</a>
	
		<a href="/tag.html#mp4" style='font-size:17px;'>mp4</a>
	
		<a href="/tag.html#webm" style='font-size:17px;'>webm</a>
	
		<a href="/tag.html#ogv" style='font-size:17px;'>ogv</a>
	
		<a href="/tag.html#javascript" style='font-size:21px;'>javascript</a>
	
		<a href="/tag.html#template" style='font-size:17px;'>template</a>
	
		<a href="/tag.html#Function" style='font-size:17px;'>Function</a>
	
		<a href="/tag.html#web-server" style='font-size:21px;'>web-server</a>
	
		<a href="/tag.html#nginx" style='font-size:23px;'>nginx</a>
	
		<a href="/tag.html#grunt" style='font-size:17px;'>grunt</a>
	
		<a href="/tag.html#docker" style='font-size:17px;'>docker</a>
	
		<a href="/tag.html#dockerfile" style='font-size:17px;'>dockerfile</a>
	
		<a href="/tag.html#Gitolite" style='font-size:19px;'>Gitolite</a>
	
		<a href="/tag.html#Hook" style='font-size:19px;'>Hook</a>
	
		<a href="/tag.html#backbone" style='font-size:21px;'>backbone</a>
	
		<a href="/tag.html#cloud" style='font-size:19px;'>cloud</a>
	
		<a href="/tag.html#markdown" style='font-size:17px;'>markdown</a>
	
		<a href="/tag.html#storage" style='font-size:23px;'>storage</a>
	
		<a href="/tag.html#disk" style='font-size:17px;'>disk</a>
	
		<a href="/tag.html#raid" style='font-size:17px;'>raid</a>
	
		<a href="/tag.html#VM" style='font-size:17px;'>VM</a>
	
		<a href="/tag.html#FileSystem" style='font-size:19px;'>FileSystem</a>
	
		<a href="/tag.html#CSS" style='font-size:17px;'>CSS</a>
	
		<a href="/tag.html#Web" style='font-size:17px;'>Web</a>
	
		<a href="/tag.html#sae" style='font-size:17px;'>sae</a>
	
		<a href="/tag.html#objective-c" style='font-size:19px;'>objective-c</a>
	
		<a href="/tag.html#ios" style='font-size:21px;'>ios</a>
	
		<a href="/tag.html#php" style='font-size:19px;'>php</a>
	
		<a href="/tag.html#memcache" style='font-size:17px;'>memcache</a>
	
		<a href="/tag.html#yii" style='font-size:19px;'>yii</a>
	
		<a href="/tag.html#phpunit" style='font-size:17px;'>phpunit</a>
	
		<a href="/tag.html#ssh" style='font-size:17px;'>ssh</a>
	
		<a href="/tag.html#rsync" style='font-size:17px;'>rsync</a>
	
		<a href="/tag.html#FastCGI" style='font-size:17px;'>FastCGI</a>
	
		<a href="/tag.html#lighttpd" style='font-size:17px;'>lighttpd</a>
	
		<a href="/tag.html#vim" style='font-size:17px;'>vim</a>
	
		<a href="/tag.html#hello world" style='font-size:17px;'>hello world</a>
	
</div>
<div class='foot text-center'>
	<p>Powered by</p><p><a href='https://github.com/'>Github</a> <a href='http://jekyllrb.com/'>jekyll</a> <a href="http://www.bootcss.com/">bootstrap</a> <a href="http://typo.sofi.sh/">typo.css</a> <a href="http://jekyllthemes.org/themes/dbyll/">Dbyll</a> <a href="http://disqus.com" class="dsq-brlink">Disqus</a>
    <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1258548781'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1258548781' type='text/javascript'%3E%3C/script%3E"));</script>
    </p>
</div>

	</div>

	<div class="col-sm-9 typo" style="background-color:#fff;">
		<div class="col-sm-8" style=" padding: 40px 0; "><div class="page-header">
  <h1>ASP.NET MVC应用require.js实践 </h1>
</div>
	
<article>

	<div class="col-sm-12">
  	<small>
	   
	   November 
	   10th,
	   
	   2013
	 </small>
	  <div class="article_body" id="article_body">
	  <p><code class="highlighter-rouge">Require.js</code>是一个支持javascript模块化编程的类库，不了解的读者请移步至：<a href="http://www.ruanyifeng.com/blog/2012/11/require_js.html">Javascript模块化编程（三）：require.js的用法</a></p>

<p>require在单页面应用中能够如鱼得水，然而对于传统的多页面应用，使用require多少会有些困惑和不方便。</p>

<p>多页面应用的一个典型的例子是<a href="https://github.com/requirejs/example-multipage">https://github.com/requirejs/example-multipage</a>，读者可以clone下来参考。本文参考这个例子在ASP.NET MVC的结构中应用require，并且给出了压缩脚本，实现半自动化压缩。</p>

<h2 id="js">将js代码分离</h2>

<p>一般而言ASP.NET MVC的一个路由对应一个视图，视图的文件结构可能如下：</p>

<pre><code>
Views
 |--Shared
     |--_layout.cshtml
 |--Home
     |--Index.cshtml
 |--Blog
     |--Create.cshtml
     |--Edit.cshtml
     |--Detail.cshtml
     |--Index.cshtml
</code></pre>

<p>这里假设<code class="highlighter-rouge">_layout.cshtml</code>是所有页面共享的。一般情况下，我们会在_layout中引用公共的js类库，比如<code class="highlighter-rouge">jQuery</code>，<code class="highlighter-rouge">bootstrap</code>等，这样的话其他的页面就不需要对这些类库再引用一遍，提高了编码的效率。然而，不同的页面终究会依赖不同的js，尤其是实现页面本身功能的自定义的js，这样我们不得不在其他页面中再引用特殊的js，甚至将js直接写在页面中，例如下面的代码经常会出现在View中：</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
   <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){...});</span>
<span class="nt">&lt;/script&gt;</span></code></pre></figure>

<p>这样会导致页面比较混乱，而且页面<code class="highlighter-rouge">&lt;script&gt;</code>标签中代码不能被浏览器缓存，增加了页面代码的长度。更为重要的缺陷是，诸如jQuery之类的类库会在加载到页面后执行匿名函数，这需要一些时间，而如果有些页面根本不需要jQuery的话，只要页面把_layout作为布局页面，那么jQuery的初始化代码将不可避免的执行，这是一种浪费。事实上，javascript的模块化加载的思想就是为了解决这些问题的。</p>

<p>接下来我们来用require规划我们的js，构建诸如下面结构的js目录</p>

<pre><code>
js
|--app
    |--home.index.js
    |--blog.create.js
    |--blog.edit.js
    |--blog.detail.js
    |--blog.index.js
|--jquery.js
|--bootstrap.js
|--underscore.js
|--jquery.ui.js
|--jquery.customplugin.js
|--config.js
|--require.js
</code></pre>

<p>把公共的类库级别的js模块直接放在js目录下，而把页面级别的js放在一个app的子目录下。注意，在app中，每个页面一个js文件，这意味着我们需要把页面各自的js提取出来，虽然这样增加了结构复杂度，但是避免了在页面中随手写<code class="highlighter-rouge">&lt;script&gt;</code>标签的陋习。另外，在js目录下的公共库，除了第三方的库，还包括自己开发的库，还有一个叫<code class="highlighter-rouge">config.js</code>的文件，这个文件很关键，稍后会说到。</p>

<p>然后，我们可以删除_layout中所有的js引用，并使用@RenderSection的命令要求子页面提供js引用，_layout.cshtml:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;head&gt;</span>
...
@RenderSection("require_js_module", false)
...
<span class="nt">&lt;/head&gt;</span></code></pre></figure>

<p>这样对js的需求就下放到每个view页面中了，根据require的用法，我们需要在各个子View中引用require.js，并指定主模块，而这些主模块就是上面app目录下的一个个js</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html">@section require_js_module{
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"@Url.Content("</span><span class="err">~/</span><span class="na">js</span><span class="err">/</span><span class="na">require</span><span class="err">.</span><span class="na">js</span><span class="err">")"</span> <span class="na">data-main=</span><span class="s">"@Url.Content("</span><span class="err">~/</span><span class="na">js</span><span class="err">/</span><span class="na">app</span><span class="err">/</span><span class="na">home</span><span class="err">.</span><span class="na">index</span><span class="err">.</span><span class="na">js</span><span class="err">")"</span> <span class="nt">&gt;&lt;/script&gt;</span>
}</code></pre></figure>

<p>所有的js代码都将写到app下的js中，这样规范了js，使得页面更干净，更为重要的是这些js还可以经过压缩，以及被浏览器缓存等，进一步提高执行效率</p>

<h2 id="config">公共的config</h2>

<p>我们知道主模块除了使用<code class="highlighter-rouge">require</code>方法外，经常需要通过<code class="highlighter-rouge">require.config</code>来配置其他模块的路径，甚至需要<code class="highlighter-rouge">shim</code>，例如下面的代码经常会出现在主模块的开头：</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
    <span class="na">paths</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"jquery"</span><span class="p">:</span> <span class="s2">"lib/jquery.min"</span><span class="p">,</span>
        <span class="s2">"underscore"</span><span class="p">:</span> <span class="s2">"lib/underscore.min"</span><span class="p">,</span>
        <span class="s2">"backbone"</span><span class="p">:</span> <span class="s2">"lib/backbone.min"</span>
    <span class="p">},</span>
    <span class="na">shim</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'underscore'</span><span class="p">:{</span>
            <span class="nl">exports</span><span class="p">:</span> <span class="s1">'_'</span>
        <span class="p">},</span>
        <span class="s1">'backbone'</span><span class="p">:</span> <span class="p">{</span>
            <span class="nl">deps</span><span class="p">:</span> <span class="p">[</span><span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'jquery'</span><span class="p">],</span>
            <span class="na">exports</span><span class="p">:</span> <span class="s1">'Backbone'</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p>对于单页面应用来说，主模块往往只有一个，所以上面的代码写一遍也就OK了。但是，在多页面的情况下，主模块有多个，每个主模块都要包含这样的代码，岂不是很不科学？于是，希望有一个统一配置的地方，但是应该如何来写呢？我们想到，将这些配置作为一个模块config.js，让其他的主模块对这个模块产生依赖就可以了，例如下面的<code class="highlighter-rouge">config.js</code>：</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">requirejs</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
    <span class="na">paths</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"jquery"</span><span class="p">:</span> <span class="s2">"/js/jquery.min"</span><span class="p">,</span>
        <span class="s2">"bootstrap"</span><span class="p">:</span> <span class="s2">"/js/bootstrap"</span>
    <span class="p">},</span>
    <span class="na">shim</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'bootstrap'</span><span class="p">:</span> <span class="p">{</span>
            <span class="nl">deps</span><span class="p">:</span> <span class="p">[</span><span class="s1">'jquery'</span><span class="p">],</span>
            <span class="na">exports</span><span class="p">:</span> <span class="s2">"jQuery.fn.popover"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p>config.js的写法没有什么特别的，接下来只要在<code class="highlighter-rouge">home.index.js</code>中引用</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">require</span><span class="p">([</span><span class="s1">'../config'</span><span class="p">,</span><span class="s1">'jquery'</span><span class="p">,</span> <span class="s1">'bootstrap'</span><span class="p">],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">//main module code here</span>

<span class="p">});</span></code></pre></figure>

<p>不过这样写还是不对的，因为，被主模块依赖的模块(这里的config,jquery,bootstrap)，在加载的时候，加载顺序是不确定的，但是又需要config模块在其他模块之前加载，怎么办呢？一个折衷的方案是修改home.index.js，成为如下代码：</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">require</span><span class="p">([</span><span class="s1">'../config'</span><span class="p">],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">require</span><span class="p">([</span><span class="s1">'home.index2'</span><span class="p">]);</span>
<span class="p">})</span>
<span class="p">,</span> <span class="nx">define</span><span class="p">(</span><span class="s2">"home.index2"</span><span class="p">,</span> <span class="p">[</span><span class="s1">'jquery'</span><span class="p">,</span> <span class="s1">'bootstrap'</span><span class="p">],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">//main module code here</span>
<span class="p">})</span></code></pre></figure>

<p>使用一个命名的模块<code class="highlighter-rouge">home.index2</code>作为过渡，在主模块中手动require，这样可以保证config在主模块执行之前加载，也就使得home.index2在加载的时候已经加载了config了。</p>

<h2 id="section">压缩</h2>

<p>require提供一个压缩工具，用于压缩和合并js，详情请移步至<a href="http://requirejs.org/docs/optimization.html">http://requirejs.org/docs/optimization.html</a>。简单的说，require提供一个叫<code class="highlighter-rouge">r.js</code>的文件，通过本地的node程序（Node.js），执行这个r.js并传入一些参数，即可自动分析模块互相之间的依赖，以达到合并和压缩的目的。同样的，这对于单页面应用来说是容易的，因为主模块只有一个，但是对于多页面又如何做呢？好在这个压缩工具支持用一个配置文件来指导压缩，这样的话，我们可以编写下面的配置脚本<code class="highlighter-rouge">build.js</code>：</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">build</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">appDir</span><span class="p">:</span> <span class="s1">'../js'</span><span class="p">,</span>
    <span class="na">baseUrl</span><span class="p">:</span> <span class="s1">'.'</span><span class="p">,</span>
    <span class="na">dir</span><span class="p">:</span> <span class="s1">'../js-built'</span><span class="p">,</span>
    <span class="na">mainConfigFile</span><span class="p">:</span> <span class="s1">'../js/config.js'</span><span class="p">,</span>
    <span class="na">modules</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1">//First set up the common build layer.</span>
        <span class="p">{</span>
            <span class="c1">//module names are relative to baseUrl</span>
            <span class="na">name</span><span class="p">:</span> <span class="s1">'config'</span><span class="p">,</span>
            <span class="c1">//List common dependencies here. Only need to list</span>
            <span class="c1">//top level dependencies, "include" will find</span>
            <span class="c1">//nested dependencies.</span>
            <span class="na">include</span><span class="p">:</span> <span class="p">[</span><span class="s2">"bootstrap"</span><span class="p">,</span> <span class="s2">"config"</span><span class="p">,</span><span class="s2">"jquery"</span><span class="p">]</span>
        <span class="p">},</span>
    <span class="c1">//Now set up a build layer for each page, but exclude</span>
        <span class="c1">//the common one. "exclude" will exclude nested</span>
        <span class="c1">//the nested, built dependencies from "common". Any</span>
        <span class="c1">//"exclude" that includes built modules should be</span>
        <span class="c1">//listed before the build layer that wants to exclude it.</span>
        <span class="c1">//"include" the appropriate "app/main*" module since by default</span>
        <span class="c1">//it will not get added to the build since it is loaded by a nested</span>
        <span class="c1">//require in the page*.js files.</span>
    <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span><span class="s2">"app/home.index"</span><span class="p">,</span>
        <span class="na">exclude</span><span class="p">:[</span><span class="s2">"config"</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span><span class="s2">"app/blog.create"</span><span class="p">,</span>
        <span class="na">exclude</span><span class="p">:[</span><span class="s2">"config"</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="p">...</span>
    <span class="p">]</span>
<span class="p">}</span></code></pre></figure>

<p>通过这个命令来执行压缩，压缩的结果将被保存到js-build目录：</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell">node.exe r.js -o build.js</code></pre></figure>

<p>build.js脚本实际上是一个js对象，我们将config加入公共模块，而在各个主模块中将其排除。这样，所有的公共库包括config将压缩成一个js，而主模块又不会包含多余的config。这样可想而知，每个页面在加载时最多只会下载两个js，而且公共模块的代码会“按需执行”。</p>

<p>执行上面的脚本压缩，需要安装有node。可以在从这里<a href="http://nodejs.org/download/">下载</a>。</p>

<h2 id="section-1">自动脚本</h2>

<p>但是，随着主模块的增加，需要随时跟踪和修改这个build文件，这也是很麻烦的。于是，笔者基于node.js开发了一个叫<code class="highlighter-rouge">build-build.js</code>的脚本，用来根据目录结构自动生成build.js：</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">target_build</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="c1">//console.log(__filename);</span>
<span class="kd">var</span> <span class="nx">pwd</span> <span class="o">=</span> <span class="nx">__dirname</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">js_path</span> <span class="o">=</span> <span class="nx">pwd</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">pwd</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">'\\'</span><span class="p">))</span> <span class="o">+</span> <span class="s1">'\\js'</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'js path : '</span> <span class="o">+</span> <span class="nx">js_path</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app_path</span> <span class="o">=</span> <span class="nx">js_path</span> <span class="o">+</span> <span class="s1">'\\app'</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'js app path : '</span> <span class="o">+</span><span class="nx">app_path</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">app_modules</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">var</span> <span class="nx">global_modules</span> <span class="o">=</span> <span class="p">[];</span>

<span class="c1">//build json object</span>
<span class="kd">var</span> <span class="nx">build</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">appDir</span><span class="p">:</span> <span class="s1">'../js'</span><span class="p">,</span>
    <span class="na">baseUrl</span><span class="p">:</span> <span class="s1">'.'</span><span class="p">,</span>
    <span class="na">dir</span><span class="p">:</span> <span class="s1">'../js-built'</span><span class="p">,</span>
    <span class="na">modules</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1">//First set up the common build layer.</span>
        <span class="p">{</span>
            <span class="c1">//module names are relative to baseUrl</span>
            <span class="na">name</span><span class="p">:</span> <span class="s1">'config'</span><span class="p">,</span>
            <span class="c1">//List common dependencies here. Only need to list</span>
            <span class="c1">//top level dependencies, "include" will find</span>
            <span class="c1">//nested dependencies.</span>
            <span class="na">include</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">app_path</span><span class="p">,</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">files</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// body...</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">files</span><span class="p">){</span>
        <span class="c1">//put module in app_modules</span>
        <span class="kd">var</span> <span class="nx">dotindex</span> <span class="o">=</span> <span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">'.'</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">dotindex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">extension</span> <span class="o">=</span> <span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="nx">dotindex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">extension</span> <span class="o">==</span> <span class="s1">'js'</span><span class="p">){</span>
                <span class="nx">app_modules</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                    <span class="na">name</span><span class="p">:</span> <span class="s1">'app/'</span> <span class="o">+</span> <span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">dotindex</span><span class="p">),</span>
                    <span class="na">exclude</span><span class="p">:</span> <span class="p">[</span><span class="s1">'config'</span><span class="p">]</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="k">in</span> <span class="nx">app_modules</span><span class="p">){</span>
        <span class="nx">build</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">app_modules</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
    <span class="p">}</span>
    
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">js_path</span><span class="p">,</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">files</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">files</span><span class="p">){</span>
            <span class="c1">//put module in app_modules</span>
            <span class="kd">var</span> <span class="nx">dotindex</span> <span class="o">=</span> <span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">'.'</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">dotindex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">extension</span> <span class="o">=</span> <span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="nx">dotindex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">extension</span> <span class="o">==</span> <span class="s1">'js'</span><span class="p">){</span>
                    <span class="nx">global_modules</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">dotindex</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">}</span>   
        <span class="p">}</span>

        <span class="nx">build</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">include</span> <span class="o">=</span> <span class="nx">global_modules</span><span class="p">;</span>
        <span class="c1">//console.log(build);</span>
        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">pwd</span> <span class="o">+</span> <span class="s1">'\\'</span> <span class="o">+</span> <span class="nx">target_build</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">fd</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">openSync</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">);</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">closeSync</span><span class="p">(</span><span class="nx">fd</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">build</span><span class="p">);</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">json</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></figure>

<p>这里的代码并不复杂，主要是遍历目录，生成对象，最后将对象序列化为build.js。读者可以自行阅读并修改。最后，编写一个bat，完成一键压缩功能，<code class="highlighter-rouge">build.bat</code>：</p>

<figure class="highlight"><pre><code class="language-bat" data-lang="bat">@echo off
set PWD=%~p0
set PWD=%PWD:\=/%
cd "D:\node"
node.exe %PWD%build-build.js build.js
node.exe %PWD%r.js -o %PWD%build.js
cd %~dp0</code></pre></figure>

<p>这样，我们就简单实现了一个方便的多页面require方案，最后项目目录可能是这样的：</p>

<pre><code>
Views
 |--Shared
     |--_layout.cshtml
 |--Home
     |--Index.cshtml
 |--Blog
     |--Create.cshtml
     |--Edit.cshtml
     |--Detail.cshtml
     |--Index.cshtml

build
|--build.js
|--r.js
|--build-build.js
|--build.bat

js
|--app
    |--home.index.js
    |--blog.create.js
    |--blog.edit.js
    |--blog.detail.js
    |--blog.index.js
|--jquery.js
|--bootstrap.js
|--underscore.js
|--jquery.ui.js
|--jquery.customplugin.js
|--config.js
|--require.js

</code></pre>

<p>可以从<a href="https://github.com/PChou/mvc-require-mutilpage-example">这里</a>fork示例程序</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/category.html#javascript">
					javascript <span>(5)</span>
					,
				</a></li>
			 
				<li><a href="/category.html#asp.net">
					asp.net <span>(1)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tag.html#require.js">
					require.js <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tag.html#asp.net mvc">
					asp.net mvc <span>(2)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tag.html#node.js">
					node.js <span>(2)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <!-- JiaThis Button BEGIN -->
		<div class="jiathis_style">
			<a class="jiathis_button_tsina"></a>
			<a class="jiathis_button_tqq"></a>
			<a class="jiathis_button_weixin"></a>
			<a class="jiathis_button_renren"></a>
			<a class="jiathis_button_douban"></a>
			<a class="jiathis_button_fb"></a>
			<a class="jiathis_button_twitter"></a>
			<a class="jiathis_button_evernote"></a>
			<a class="jiathis_button_qzone"></a>
			<a class="jiathis_button_ydnote"></a>
			<a class="jiathis_button_linkedin"></a>
			<a href="http://www.jiathis.com/share?uid=1900073" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
			<a class="jiathis_counter_style"></a>
		</div>
		<script type="text/javascript">
		var jiathis_config = {data_track_clickback:'true'};
		</script>
		<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=1900073" charset="utf-8"></script>
		<!-- JiaThis Button END -->
      </section>

      <section class="col-sm-6 author">

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/algorithm/2013/11/07/527ba36a16888.html" title="数据库一致性原理浅析">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/network/hardware/2013/11/28/529753c0d8e54.html" title="交换基础">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
<!-- 	<div class="col-sm-2 sidebar-2">
	
	</div> -->
	<div id="disqus_thread"></div>
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'pchou'; // required: replace example with your forum shortname

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


 <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'pchou'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
</article>

<div class="clearfix"></div>

</div>
			<div class="col-sm-4 hidden-xs typo" style=" padding-top: 90px; ">
		<h4>扫一扫，手机阅读</h4>
		<div class='qrcode'></div>

		<div id="sideBar">
		</div>

	</div>

	</div>


	<script src="http://cdn.bootcss.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
	<script src="http://cdn.bootcss.com/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/stick.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>

