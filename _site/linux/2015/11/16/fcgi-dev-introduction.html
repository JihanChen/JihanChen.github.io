<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>FastCGI+lighttpd开发之介绍和环境搭建</title>
	
	<meta name="author" content="JihanChen">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/typo/typo.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css?v=1.1" rel="stylesheet">

	<!-- Le fav and touch icons -->
	
	<link rel="icon" href="/favicon.ico" type="image/x-icon">
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	<!-- Update these with your own images
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/rss.xml">

	<!-- <script src="http://cdn.bootcss.com/jquery/1.8.2/jquery.min.js"></script> -->
	<script src="http://cdn.bootcss.com/jquery/1.10.1/jquery.min.js"></script>
</head>

<body>
 	<nav class="navbar-default visible-xs">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
		</div>

		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li><a href="/">首页</a></li>
				<li><a href="/category.html">分类</a></li>
				<li><a href="/tag.html">标签</a></li>
				<li><a href="/series.html">系列文章</a></li>
			</ul>
		</div>
	</nav>

	<div id="left-side" class="col-sm-3 sidebar hidden-xs">
		<!-- 
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="http://www.gravatar.com/avatar/?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/"></a>
    </h3>
</header> -->


<div id="bio" class="text-center">
	Do not build on quicksand high
</div>


<div class='navigator text-center'>
	<a href='/index.html' title='首页'>&#xf012b;</a>
	<a href='/rss.xml' title='RSS订阅'>&#xf01bc;</a>
	<!-- <a href='/me.html' title='关于我'>&#xf00cc;</a> -->
	<a href='/series.html' title='系列文章'>&#xf0161;</a>
</div>

<div class='category'>
	<ul>
		
			<li><a href="/category.html#life">life<span>5</span></a></li>
		
			<li><a href="/category.html#web-build">web-build<span>13</span></a></li>
		
			<li><a href="/category.html#resource">resource<span>3</span></a></li>
		
			<li><a href="/category.html#network">network<span>7</span></a></li>
		
			<li><a href="/category.html#C-Cpp">C-Cpp<span>6</span></a></li>
		
			<li><a href="/category.html#Linux">Linux<span>1</span></a></li>
		
			<li><a href="/category.html#Hardware">Hardware<span>1</span></a></li>
		
			<li><a href="/category.html#BMC">BMC<span>8</span></a></li>
		
			<li><a href="/category.html#Web">Web<span>5</span></a></li>
		
			<li><a href="/category.html#algorithm">algorithm<span>2</span></a></li>
		
			<li><a href="/category.html#hardware">hardware<span>9</span></a></li>
		
			<li><a href="/category.html#javascript">javascript<span>5</span></a></li>
		
			<li><a href="/category.html#asp.net">asp.net<span>1</span></a></li>
		
			<li><a href="/category.html#open-source">open-source<span>12</span></a></li>
		
			<li><a href="/category.html#web">web<span>3</span></a></li>
		
			<li><a href="/category.html#c-cpp">c-cpp<span>3</span></a></li>
		
			<li><a href="/category.html#IOS">IOS<span>3</span></a></li>
		
			<li><a href="/category.html#linux">linux<span>3</span></a></li>
		
	</ul>
</div>

<div class='tags'>
	
		<a href="/tag.html#github-page" style='font-size:43px;'>github-page</a>
	
		<a href="/tag.html#jekyll" style='font-size:33px;'>jekyll</a>
	
		<a href="/tag.html#liquid" style='font-size:21px;'>liquid</a>
	
		<a href="/tag.html#Git" style='font-size:23px;'>Git</a>
	
		<a href="/tag.html#Ruby" style='font-size:19px;'>Ruby</a>
	
		<a href="/tag.html#Linux" style='font-size:21px;'>Linux</a>
	
		<a href="/tag.html#SEO" style='font-size:17px;'>SEO</a>
	
		<a href="/tag.html#FTP" style='font-size:17px;'>FTP</a>
	
		<a href="/tag.html#NAT" style='font-size:17px;'>NAT</a>
	
		<a href="/tag.html#CPP" style='font-size:29px;'>CPP</a>
	
		<a href="/tag.html#dot NET" style='font-size:21px;'>dot NET</a>
	
		<a href="/tag.html#Compiler" style='font-size:21px;'>Compiler</a>
	
		<a href="/tag.html#Hardware" style='font-size:23px;'>Hardware</a>
	
		<a href="/tag.html#Performance" style='font-size:21px;'>Performance</a>
	
		<a href="/tag.html#BMC" style='font-size:27px;'>BMC</a>
	
		<a href="/tag.html#Web dev" style='font-size:19px;'>Web dev</a>
	
		<a href="/tag.html#Remedy" style='font-size:29px;'>Remedy</a>
	
		<a href="/tag.html#ITSM" style='font-size:17px;'>ITSM</a>
	
		<a href="/tag.html#Mid-Tier" style='font-size:17px;'>Mid-Tier</a>
	
		<a href="/tag.html#SSO" style='font-size:17px;'>SSO</a>
	
		<a href="/tag.html#algorithm" style='font-size:17px;'>algorithm</a>
	
		<a href="/tag.html#web-build" style='font-size:19px;'>web-build</a>
	
		<a href="/tag.html#bootstrap" style='font-size:19px;'>bootstrap</a>
	
		<a href="/tag.html#PHP" style='font-size:19px;'>PHP</a>
	
		<a href="/tag.html#Esxi" style='font-size:17px;'>Esxi</a>
	
		<a href="/tag.html#iso" style='font-size:17px;'>iso</a>
	
		<a href="/tag.html#Driver" style='font-size:17px;'>Driver</a>
	
		<a href="/tag.html#database" style='font-size:19px;'>database</a>
	
		<a href="/tag.html#consistency" style='font-size:17px;'>consistency</a>
	
		<a href="/tag.html#require.js" style='font-size:17px;'>require.js</a>
	
		<a href="/tag.html#asp.net mvc" style='font-size:19px;'>asp.net mvc</a>
	
		<a href="/tag.html#node.js" style='font-size:19px;'>node.js</a>
	
		<a href="/tag.html#network" style='font-size:25px;'>network</a>
	
		<a href="/tag.html#switch" style='font-size:25px;'>switch</a>
	
		<a href="/tag.html#VLAN" style='font-size:19px;'>VLAN</a>
	
		<a href="/tag.html#Trunk" style='font-size:17px;'>Trunk</a>
	
		<a href="/tag.html#VTP" style='font-size:17px;'>VTP</a>
	
		<a href="/tag.html#STP" style='font-size:17px;'>STP</a>
	
		<a href="/tag.html#compiler" style='font-size:19px;'>compiler</a>
	
		<a href="/tag.html#yacc" style='font-size:17px;'>yacc</a>
	
		<a href="/tag.html#lex" style='font-size:17px;'>lex</a>
	
		<a href="/tag.html#life" style='font-size:19px;'>life</a>
	
		<a href="/tag.html#PVST" style='font-size:17px;'>PVST</a>
	
		<a href="/tag.html#FSD" style='font-size:17px;'>FSD</a>
	
		<a href="/tag.html#Programmer" style='font-size:17px;'>Programmer</a>
	
		<a href="/tag.html#PLY" style='font-size:17px;'>PLY</a>
	
		<a href="/tag.html#Python" style='font-size:17px;'>Python</a>
	
		<a href="/tag.html#Lex" style='font-size:17px;'>Lex</a>
	
		<a href="/tag.html#Yacc" style='font-size:17px;'>Yacc</a>
	
		<a href="/tag.html#grid" style='font-size:17px;'>grid</a>
	
		<a href="/tag.html#html5" style='font-size:17px;'>html5</a>
	
		<a href="/tag.html#video" style='font-size:17px;'>video</a>
	
		<a href="/tag.html#mp4" style='font-size:17px;'>mp4</a>
	
		<a href="/tag.html#webm" style='font-size:17px;'>webm</a>
	
		<a href="/tag.html#ogv" style='font-size:17px;'>ogv</a>
	
		<a href="/tag.html#javascript" style='font-size:21px;'>javascript</a>
	
		<a href="/tag.html#template" style='font-size:17px;'>template</a>
	
		<a href="/tag.html#Function" style='font-size:17px;'>Function</a>
	
		<a href="/tag.html#web-server" style='font-size:21px;'>web-server</a>
	
		<a href="/tag.html#nginx" style='font-size:23px;'>nginx</a>
	
		<a href="/tag.html#grunt" style='font-size:17px;'>grunt</a>
	
		<a href="/tag.html#docker" style='font-size:17px;'>docker</a>
	
		<a href="/tag.html#dockerfile" style='font-size:17px;'>dockerfile</a>
	
		<a href="/tag.html#Gitolite" style='font-size:19px;'>Gitolite</a>
	
		<a href="/tag.html#Hook" style='font-size:19px;'>Hook</a>
	
		<a href="/tag.html#backbone" style='font-size:21px;'>backbone</a>
	
		<a href="/tag.html#cloud" style='font-size:19px;'>cloud</a>
	
		<a href="/tag.html#markdown" style='font-size:17px;'>markdown</a>
	
		<a href="/tag.html#storage" style='font-size:23px;'>storage</a>
	
		<a href="/tag.html#disk" style='font-size:17px;'>disk</a>
	
		<a href="/tag.html#raid" style='font-size:17px;'>raid</a>
	
		<a href="/tag.html#VM" style='font-size:17px;'>VM</a>
	
		<a href="/tag.html#FileSystem" style='font-size:19px;'>FileSystem</a>
	
		<a href="/tag.html#CSS" style='font-size:17px;'>CSS</a>
	
		<a href="/tag.html#Web" style='font-size:17px;'>Web</a>
	
		<a href="/tag.html#sae" style='font-size:17px;'>sae</a>
	
		<a href="/tag.html#objective-c" style='font-size:19px;'>objective-c</a>
	
		<a href="/tag.html#ios" style='font-size:21px;'>ios</a>
	
		<a href="/tag.html#php" style='font-size:19px;'>php</a>
	
		<a href="/tag.html#memcache" style='font-size:17px;'>memcache</a>
	
		<a href="/tag.html#yii" style='font-size:19px;'>yii</a>
	
		<a href="/tag.html#phpunit" style='font-size:17px;'>phpunit</a>
	
		<a href="/tag.html#ssh" style='font-size:17px;'>ssh</a>
	
		<a href="/tag.html#rsync" style='font-size:17px;'>rsync</a>
	
		<a href="/tag.html#FastCGI" style='font-size:17px;'>FastCGI</a>
	
		<a href="/tag.html#lighttpd" style='font-size:17px;'>lighttpd</a>
	
		<a href="/tag.html#vim" style='font-size:17px;'>vim</a>
	
		<a href="/tag.html#hello world" style='font-size:17px;'>hello world</a>
	
</div>
<div class='foot text-center'>
	<p>Powered by</p><p><a href='https://github.com/'>Github</a> <a href='http://jekyllrb.com/'>jekyll</a> <a href="http://www.bootcss.com/">bootstrap</a> <a href="http://typo.sofi.sh/">typo.css</a> <a href="http://jekyllthemes.org/themes/dbyll/">Dbyll</a> <a href="http://disqus.com" class="dsq-brlink">Disqus</a>
    <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1258548781'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1258548781' type='text/javascript'%3E%3C/script%3E"));</script>
    </p>
</div>

	</div>

	<div class="col-sm-9 typo" style="background-color:#fff;">
		<div class="col-sm-8" style=" padding: 40px 0; "><div class="page-header">
  <h1>FastCGI+lighttpd开发之介绍和环境搭建 </h1>
</div>
	
<article>

	<div class="col-sm-12">
  	<small>
	   
	   November 
	   16th,
	   
	   2015
	 </small>
	  <div class="article_body" id="article_body">
	  <p>由于需要做一些简单的基于FastCGI的Web开发，开始学习和调研，本篇介绍CGI和FastCGI的概念以及基于FastCGI官方的devkit，以及lighttpd搭建起简单的开发环境，以作备忘。</p>

<h2 id="section">为啥要搞这个?</h2>

<p>现在开发Web有N种选择，啥php，C#，java，ruby，nodejs…哪个都比开发FastCGI要简单和强大的多，为何还要跑到这么个底层来做Web服务呢？答案是嵌入式系统需求！我们知道嵌入式系统往往由于硬件的限制，为了节约处理器和内存，很多事情都需要省的点用。对于简单的Web服务，没有必要（或者不能）去使用高层次的编程框架，那么这个时候，就可以直接基于CGI那套协议来进行开发。通常在这个层次下，C语言是首选。</p>

<h2 id="fastcgicgi">FastCGI和CGI的概念</h2>

<p>要搞清楚FastCGI，必须先搞清楚CGI</p>

<p>参考</p>

<p><a href="http://www.cnblogs.com/wanghetao/p/3934350.html">CGI与FastCGI</a></p>

<p><a href="http://www.cnblogs.com/skynet/p/4173450.html">Nginx + CGI/FastCGI + C/Cpp</a></p>

<p><a href="http://segmentfault.com/q/1010000000256516">搞不清FastCgi与PHP-fpm之间是个什么样的关系</a></p>

<h3 id="cgi">CGI</h3>

<p>CGI是一种协议，用于扩展Web服务器原本的能力。我们知道，Web服务器最早是用来提供静态文件访问的，想要实现动态内容提供是比较困难的。CGI因此而产生。这是一套协议，简单的说，就是Web服务器在必要的时候，为了处理Request，会调起一个进程（CGI程序），让这个进程来处理请求，并将这个进程返回的结果返回给客户端。然后进程结束，下次请求重复这个过程。这个过程中涉及到Web进程和CGI程序进程的输入和输出协议，这个机制和协议就叫CGI。那么具体的说，在CGI程序中，输入和输出是通过<code class="highlighter-rouge">stdin</code>,<code class="highlighter-rouge">stdout</code>,<code class="highlighter-rouge">stderr</code>来进行的，请求的参数等则是通过环境变量来传递的。所以CGI程序其实没有语言限制，只要能够读取环境变量，读写标准输入输出即可。下图以Apache和Python为例，说明CGI的工作方式</p>

<p><img src="http://pchou.qiniudn.com/fcgi-dev-introduction-00.jpg" alt="" /></p>

<p>Python的CGI扩展能够在Python解释器的帮助下，解释用户编写的Python脚本，从而输入输出，虽然这个模型相比上面阐述的基本模型要复杂一点，但是本质是相同的。</p>

<p>CGI的缺点很明显，每个请求都要启动进程来处理请求，进程启动的开销是没有必要的。</p>

<h3 id="fastcgi">FastCGI</h3>

<p>为了解决CGI的缺点，诞生了FastCGI。既然CGI的缺点是进程的频繁启动和关闭，那么是否可以有一个专门管理CGI进程的程序，在没有Request请求的情况下，保持多个CGI进程的挂起状态，当有请求的时候，分配一个进程来处理，处理完成后挂起，就像是进程池一样。这个进程池的管理程序称为<code class="highlighter-rouge">FastCGI管理器</code>，从字面看，它可以提高CGI程序的效率。</p>

<p>不光是处理模型的优化，CGI程序只能在Web服务器本机执行，而基于FastCGI的管理下，CGI程序可以被部署在远程，通过TCP Socket或者Unix domain Socket来传输数据，这种模式可以理解为<code class="highlighter-rouge">FastCGI代理</code>。</p>

<p><code class="highlighter-rouge">FastCGI管理器</code>有多种形式。例如：Apache和Lighttpd是通过模块的方式实现<code class="highlighter-rouge">FastCGI管理器</code>的，而Nginx则是通过<code class="highlighter-rouge">FastCGI代理</code>模式实现的（也就是说需要一个单独的<code class="highlighter-rouge">FastCGI管理器</code>进程，该进程通过侦听TCP Socket或者Unix domain Socket在Nginx和CGI程序之间起到桥梁作用）。</p>

<p>同样是Apache和Python为例，下图为FastCGI的启动和运行的模型</p>

<p><img src="http://pchou.qiniudn.com/fcgi-dev-introduction-01.jpg" alt="" /></p>

<p>Apache在调用用户脚本的时候，会依靠Apache内建的FastCGI模块来调度CGI进程，CGI进程也不会消亡，下次请求就不需要重新启动解析器了。而且CGI进程是通过Socket形式实现输入输出的，当然CGI程序在编写的时候，仍然是通过stdin,stdout,stderr来输入输出，只是最终可能是通过网络来实现的，这样做可以实现从CGI程序到FastCGI程序的平滑过渡。你会发现开发FastCGI程序跟开发CGI程序并没有多少区别。</p>

<p>关于Nginx的FastCGI代理模式，有必要多说几句。Nginx自身没有实现FastCGI管理器，但是Nginx可以支持FastCGI代理，我们来看看Nginx是如何配置php的就明白了：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">location ~ <span class="se">\.</span>php<span class="nv">$ </span><span class="o">{</span>
    root  html;
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  /scripts<span class="nv">$fastcgi_script_name</span>;
    include        fastcgi_params;
<span class="o">}</span></code></pre></figure>

<p>可以看到，Nginx其实是把请求扔给<code class="highlighter-rouge">127.0.0.1:9000</code>，那么还需要一个程序来监听<code class="highlighter-rouge">127.0.0.1:9000</code>啊，对了！这个程序就是<code class="highlighter-rouge">php-fpm</code>，所以我们在用Nginx配置php的时候需要：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">php-fpm start</code></pre></figure>

<p><code class="highlighter-rouge">php-fpm</code>可以帮Nginx实现CGI进程管理器的功能。看起来好麻烦有没有，为什么Apache无需<code class="highlighter-rouge">php-fpm</code>，原因上面说了，Apache是通过模块实现的，无需单独启动<code class="highlighter-rouge">php-fpm</code>。</p>

<p>那么，如何开始开发一个FastCGI程序呢，我们需要FastCGI的开发套件，以及一个合适的Web服务器，这里FastCGI套件从<a href="http://www.fastcgi.com/drupal/node/5">这里</a>下载，Web服务器，我们选择了lighttpd，因为既然要直接开发CGI程序，那么通常你会选择尽可能轻量的Web服务器。当然支持FastCGI的Web服务器很多，<a href="http://www.fastcgi.com/drupal/node/3">这里</a>有列表。</p>

<h2 id="lighttpd">准备lighttpd</h2>

<p><a href="http://www.lighttpd.net/">lighttpd</a>的安装就不多说了，你可以选择编译安装或者源安装，我选择了编译安装，所以后续的启动啥的麻烦一点。</p>

<h3 id="lighttpd-1">lighttpd的启动和重启</h3>

<p>如果是编译安装的，那么你需要将源码包<code class="highlighter-rouge">doc</code>里面的<code class="highlighter-rouge">config</code>文件夹复制到<code class="highlighter-rouge">/etc</code>下，并重命名为<code class="highlighter-rouge">lighttpd</code>，这里面是lighttpd的一系列启动配置，然后像下面这样启动：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/usr/local/sbin/lighttpd -f /etc/lighttpd/lighttpd.conf</code></pre></figure>

<p>如果你经常折腾Web服务器，这应该很好理解。当然你可以查看一下配置文件，了解个大概（尤其是日志文件的位置），由于配置文件有很多注释，分享一个命令，能去掉注释部分，只看重点：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">sed -n <span class="s1">'/^\s*[^#]/p'</span> /etc/lighttpd/lighttpd.conf</code></pre></figure>

<p>重启的话，可以通过下面命令先杀掉相关的进程，然后再启动</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">killall lighttpd
/usr/local/sbin/lighttpd -f /etc/lighttpd/lighttpd.conf</code></pre></figure>

<h3 id="lighttpdfastcgi">lighttpd配置fastcgi模块</h3>

<p>这个相对简单，在<code class="highlighter-rouge">/etc/lighttpd/modules.conf</code>，将里面的fastcgi模块的引用反注释掉</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">include <span class="s2">"conf.d/fastcgi.conf"</span></code></pre></figure>

<p>那么关于fastcgi的配置就顺理成章的在<code class="highlighter-rouge">conf.d/fastcgi.conf</code>中了，其中关键的一句是：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">server.modules +<span class="o">=</span> <span class="o">(</span> <span class="s2">"mod_fastcgi"</span> <span class="o">)</span></code></pre></figure>

<p>底下有很多示例配置，尤其是对php的配置示例，尤其详细，然而我们是直接做CGI程序，可以参考这个配置</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">fastcgi.debug <span class="o">=</span> 1
fastcgi.server <span class="o">=</span> <span class="o">(</span>
	<span class="s2">".fcgi"</span> <span class="o">=</span>&gt; <span class="o">(</span>
	 <span class="s2">"local"</span> <span class="o">=</span>&gt; <span class="o">(</span>
	  <span class="s2">"socket"</span> <span class="o">=</span>&gt; socket_dir + <span class="s2">"fcgitest-fcgi.socket"</span>,
	  <span class="s2">"checklocal"</span> <span class="o">=</span>&gt; <span class="s2">"disable"</span>,
	  <span class="s2">"bin-path"</span> <span class="o">=</span>&gt; server_root + <span class="s2">"/htdocs/cgi-bin/fh.fcgi"</span>,
	  <span class="s2">"idle-timeout"</span> <span class="o">=</span>&gt; 10,
	  <span class="s2">"min-procs"</span> <span class="o">=</span>&gt; 1,
	  <span class="s2">"max-procs"</span> <span class="o">=</span>&gt; 1
	 <span class="o">)</span>
	<span class="o">)</span>
<span class="o">)</span></code></pre></figure>

<p>理解了FastCGI原理后，再来看这个其实很容易理解：</p>

<ol>
  <li>对所有.fcgi后缀的处理</li>
  <li>通过<code class="highlighter-rouge">fcgitest-fcgi.socket</code></li>
  <li>用<code class="highlighter-rouge">/htdocs/cgi-bin/fh.fcgi</code>程序来处理</li>
  <li>最多同时驻留1个CGI进程，最少1个（对于嵌入式系统，并不是要处理高并发，多个进程并没有意义）</li>
</ol>

<p>我们可以通过浏览器访问http://localhost/cgi-bin/fh.fcgi，即可执行fh.fcgi程序（这里htdocs是配置的文档根目录）。</p>

<p>那么接下来的重点是开发<code class="highlighter-rouge">/htdocs/cgi-bin/fh.fcgi</code>程序。</p>

<h2 id="fastcgi-1">开始开发FastCGI程序</h2>

<h3 id="section-1">开发套件的安装</h3>

<p>下载好套件后，解压在fcgi-devel-kit目录</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd </span>fcgi-devel-kit
./configure
make
<span class="nb">cd </span>libfcgi
make
make install</code></pre></figure>

<p>显然我们其实需要的是FastCGI的<code class="highlighter-rouge">include</code>和<code class="highlighter-rouge">lib</code>，上面的命令可以在<code class="highlighter-rouge">/usr/local/lib</code>下创建几个相关的库文件：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">-rw-r--r--.  1 root root 204902 Nov 15 20:09 libfcgi.a
-rwxr-xr-x.  1 root root    704 Nov 15 20:09 libfcgi.la
lrwxrwxrwx.  1 root root     16 Nov 15 20:09 libfcgi.so -&gt; libfcgi.so.0.0.0
lrwxrwxrwx.  1 root root     16 Nov 15 20:09 libfcgi.so.0 -&gt; libfcgi.so.0.0.0
-rwxr-xr-x.  1 root root 145320 Nov 15 20:09 libfcgi.so.0.0.0</code></pre></figure>

<p>.a是静态库，.la是基于<a href="http://www.ibm.com/developerworks/cn/aix/library/1007_wuxh_libtool/">libtool</a>的链接库。后面你可以选择使用.a来链接，也可以使用libtool工具，使用.la来构建。</p>

<p>完成套件的安装后，先创建一个项目文件，并将include和libtool工具拷贝进去（如果你不打算用libtool编译，可以不拷贝libtool）</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir -p ~/Projects/fh
cp -r ~/fcgi-devel-kit/include ~/Project/fh/fcgi_inc
cp ~/fcgi-devel-kit/libtool ~/Project/fh/libtool</code></pre></figure>

<p>创建一个main.c文件，并编辑如下：</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;fcgi_stdio.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(){</span>
 <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="k">while</span><span class="p">(</span><span class="n">FCGI_Accept</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">){</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"Content-type: text/html</span><span class="se">\r\n</span><span class="s">"</span>
           <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>
           <span class="s">"&lt;title&gt;FastCGI Hello! (C, fcgi_stdio library)&lt;/title&gt;"</span>
           <span class="s">"&lt;h1&gt;FastCGI Hello! (C, fcgi_stdio library)&lt;/h1&gt;"</span>
           <span class="s">"Request number %d running on host &lt;i&gt;%s&lt;/i&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="o">++</span><span class="n">count</span><span class="p">,</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"SERVER_NAME"</span><span class="p">));</span>
 <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>上面的程序跟普通的CGI程序的关键区别在于<code class="highlighter-rouge">while(FCGI_Accept() &gt;= 0)</code>，这个条件会在没有请求需要处理的时候阻塞，那么进程就会挂起，并在正常情况下不会退出。这样就实现了进程驻留的效果。</p>

<h3 id="section-2">编译和链接</h3>

<p>使用<code class="highlighter-rouge">libtool</code>进行编译和链接</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">./libtool --mode<span class="o">=</span>compile gcc -I fcgi_inc -c main.c

rm -f .libs/main.lo
gcc -I fcgi_inc -c main.c  -fPIC -DPIC -o .libs/main.lo
gcc -I fcgi_inc -c main.c -o main.o &gt;/dev/null 2&gt;&amp;1
mv -f .libs/main.lo main.lo</code></pre></figure>

<p>编译得到的是<code class="highlighter-rouge">main.lo</code>和<code class="highlighter-rouge">main.o</code>，前者用于继续用libtool链接FastCGI的lib，后者可用于普通的链接。</p>

<p>接着链接：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">./libtool --mode<span class="o">=</span>link gcc -o fh main.lo /usr/local/lib/libfcgi.la

gcc -o fh main.o  /usr/local/lib/libfcgi.so -lnsl  -Wl,--rpath -Wl,/usr/local/lib -Wl,--rpath -Wl,/usr/local/lib</code></pre></figure>

<p>得到的程序<code class="highlighter-rouge">fh</code>，是通过<code class="highlighter-rouge">main.o</code>和<code class="highlighter-rouge">/usr/local/lib/libfcgi.so</code>链接后生成的（动态链接），可以看到libtool实际上只是对gcc的一个包装而已。据说是为了方便解决依赖库，笔者折腾了好久才弄清楚。</p>

<p>最后，将<code class="highlighter-rouge">fh</code>复制到目标目录，并重命名。当然如果fh.fcgi进程已经由lighttpd启动，需要杀掉进程，再覆盖。</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">cp -f fh /srv/www/htdocs/cgi-bin/fh.fcgi</code></pre></figure>

<p>最后使用浏览器的访问效果：</p>

<p><img src="http://pchou.qiniudn.com/fcgi-dev-introduction-02.png" alt="" /></p>

<p>需要注意的是，访问的文件还是必须物理存在的（因为没有配置任何rewrite），比如这里访问的cgi-bin/fg.fcgi，实际上映射了/srv/www/htdocs/cgi-bin/fg.fcgi文件，然后再用fastcgi的方式来处理。否则只会返回404，笔者在这里卡了一下。</p>

<h2 id="section-3">结语</h2>

<p>花了一天时间，简单实验的FastCGI的开发，后续还需要使用IDE来开发，并实现交叉编译，后面再折腾了。</p>


	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/category.html#linux">
					linux <span>(3)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tag.html#FastCGI">
					FastCGI <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tag.html#lighttpd">
					lighttpd <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <!-- JiaThis Button BEGIN -->
		<div class="jiathis_style">
			<a class="jiathis_button_tsina"></a>
			<a class="jiathis_button_tqq"></a>
			<a class="jiathis_button_weixin"></a>
			<a class="jiathis_button_renren"></a>
			<a class="jiathis_button_douban"></a>
			<a class="jiathis_button_fb"></a>
			<a class="jiathis_button_twitter"></a>
			<a class="jiathis_button_evernote"></a>
			<a class="jiathis_button_qzone"></a>
			<a class="jiathis_button_ydnote"></a>
			<a class="jiathis_button_linkedin"></a>
			<a href="http://www.jiathis.com/share?uid=1900073" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
			<a class="jiathis_counter_style"></a>
		</div>
		<script type="text/javascript">
		var jiathis_config = {data_track_clickback:'true'};
		</script>
		<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=1900073" charset="utf-8"></script>
		<!-- JiaThis Button END -->
      </section>

      <section class="col-sm-6 author">

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/open-source/2015/11/14/githook-rsync.html" title="githook+rsync简单实现web部署">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/linux/2015/12/02/vim-resource.html" title="开始vim练级">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
<!-- 	<div class="col-sm-2 sidebar-2">
	
	</div> -->
	<div id="disqus_thread"></div>
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'pchou'; // required: replace example with your forum shortname

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


 <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'pchou'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
</article>

<div class="clearfix"></div>

</div>
			<div class="col-sm-4 hidden-xs typo" style=" padding-top: 90px; ">
		<h4>扫一扫，手机阅读</h4>
		<div class='qrcode'></div>

		<div id="sideBar">
		</div>

	</div>

	</div>


	<script src="http://cdn.bootcss.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
	<script src="http://cdn.bootcss.com/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/stick.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>

