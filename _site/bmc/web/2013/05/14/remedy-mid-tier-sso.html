<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Remedy Mid-tier SSO</title>
	
	<meta name="description" content="需要在Mid-tier环境和非Mid-tier环境之间进行SSO的话，可以参考本文给出的方案。与此同时，本文也针对SSO现在常用的方案进行了一些简单的整理。">
	
	<meta name="author" content="JihanChen">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/typo/typo.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css?v=1.1" rel="stylesheet">

	<!-- Le fav and touch icons -->
	
	<link rel="icon" href="/favicon.ico" type="image/x-icon">
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	<!-- Update these with your own images
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/rss.xml">

	<!-- <script src="http://cdn.bootcss.com/jquery/1.8.2/jquery.min.js"></script> -->
	<script src="http://cdn.bootcss.com/jquery/1.10.1/jquery.min.js"></script>
</head>

<body>
 	<nav class="navbar-default visible-xs">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
		</div>

		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li><a href="/">首页</a></li>
				<li><a href="/category.html">分类</a></li>
				<li><a href="/tag.html">标签</a></li>
				<li><a href="/series.html">系列文章</a></li>
			</ul>
		</div>
	</nav>

	<div id="left-side" class="col-sm-3 sidebar hidden-xs">
		<!-- 
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="http://www.gravatar.com/avatar/?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/"></a>
    </h3>
</header> -->


<div id="bio" class="text-center">
	Do not build on quicksand high
</div>


<div class='navigator text-center'>
	<a href='/index.html' title='首页'>&#xf012b;</a>
	<a href='/rss.xml' title='RSS订阅'>&#xf01bc;</a>
	<!-- <a href='/me.html' title='关于我'>&#xf00cc;</a> -->
	<a href='/series.html' title='系列文章'>&#xf0161;</a>
</div>

<div class='category'>
	<ul>
		
			<li><a href="/category.html#life">life<span>5</span></a></li>
		
			<li><a href="/category.html#web-build">web-build<span>13</span></a></li>
		
			<li><a href="/category.html#resource">resource<span>3</span></a></li>
		
			<li><a href="/category.html#network">network<span>7</span></a></li>
		
			<li><a href="/category.html#C-Cpp">C-Cpp<span>6</span></a></li>
		
			<li><a href="/category.html#Linux">Linux<span>1</span></a></li>
		
			<li><a href="/category.html#Hardware">Hardware<span>1</span></a></li>
		
			<li><a href="/category.html#BMC">BMC<span>8</span></a></li>
		
			<li><a href="/category.html#Web">Web<span>5</span></a></li>
		
			<li><a href="/category.html#algorithm">algorithm<span>2</span></a></li>
		
			<li><a href="/category.html#hardware">hardware<span>9</span></a></li>
		
			<li><a href="/category.html#javascript">javascript<span>5</span></a></li>
		
			<li><a href="/category.html#asp.net">asp.net<span>1</span></a></li>
		
			<li><a href="/category.html#open-source">open-source<span>12</span></a></li>
		
			<li><a href="/category.html#web">web<span>3</span></a></li>
		
			<li><a href="/category.html#c-cpp">c-cpp<span>3</span></a></li>
		
			<li><a href="/category.html#IOS">IOS<span>3</span></a></li>
		
			<li><a href="/category.html#linux">linux<span>3</span></a></li>
		
	</ul>
</div>

<div class='tags'>
	
		<a href="/tag.html#github-page" style='font-size:43px;'>github-page</a>
	
		<a href="/tag.html#jekyll" style='font-size:33px;'>jekyll</a>
	
		<a href="/tag.html#liquid" style='font-size:21px;'>liquid</a>
	
		<a href="/tag.html#Git" style='font-size:23px;'>Git</a>
	
		<a href="/tag.html#Ruby" style='font-size:19px;'>Ruby</a>
	
		<a href="/tag.html#Linux" style='font-size:21px;'>Linux</a>
	
		<a href="/tag.html#SEO" style='font-size:17px;'>SEO</a>
	
		<a href="/tag.html#FTP" style='font-size:17px;'>FTP</a>
	
		<a href="/tag.html#NAT" style='font-size:17px;'>NAT</a>
	
		<a href="/tag.html#CPP" style='font-size:29px;'>CPP</a>
	
		<a href="/tag.html#dot NET" style='font-size:21px;'>dot NET</a>
	
		<a href="/tag.html#Compiler" style='font-size:21px;'>Compiler</a>
	
		<a href="/tag.html#Hardware" style='font-size:23px;'>Hardware</a>
	
		<a href="/tag.html#Performance" style='font-size:21px;'>Performance</a>
	
		<a href="/tag.html#BMC" style='font-size:27px;'>BMC</a>
	
		<a href="/tag.html#Web dev" style='font-size:19px;'>Web dev</a>
	
		<a href="/tag.html#Remedy" style='font-size:29px;'>Remedy</a>
	
		<a href="/tag.html#ITSM" style='font-size:17px;'>ITSM</a>
	
		<a href="/tag.html#Mid-Tier" style='font-size:17px;'>Mid-Tier</a>
	
		<a href="/tag.html#SSO" style='font-size:17px;'>SSO</a>
	
		<a href="/tag.html#algorithm" style='font-size:17px;'>algorithm</a>
	
		<a href="/tag.html#web-build" style='font-size:19px;'>web-build</a>
	
		<a href="/tag.html#bootstrap" style='font-size:19px;'>bootstrap</a>
	
		<a href="/tag.html#PHP" style='font-size:19px;'>PHP</a>
	
		<a href="/tag.html#Esxi" style='font-size:17px;'>Esxi</a>
	
		<a href="/tag.html#iso" style='font-size:17px;'>iso</a>
	
		<a href="/tag.html#Driver" style='font-size:17px;'>Driver</a>
	
		<a href="/tag.html#database" style='font-size:19px;'>database</a>
	
		<a href="/tag.html#consistency" style='font-size:17px;'>consistency</a>
	
		<a href="/tag.html#require.js" style='font-size:17px;'>require.js</a>
	
		<a href="/tag.html#asp.net mvc" style='font-size:19px;'>asp.net mvc</a>
	
		<a href="/tag.html#node.js" style='font-size:19px;'>node.js</a>
	
		<a href="/tag.html#network" style='font-size:25px;'>network</a>
	
		<a href="/tag.html#switch" style='font-size:25px;'>switch</a>
	
		<a href="/tag.html#VLAN" style='font-size:19px;'>VLAN</a>
	
		<a href="/tag.html#Trunk" style='font-size:17px;'>Trunk</a>
	
		<a href="/tag.html#VTP" style='font-size:17px;'>VTP</a>
	
		<a href="/tag.html#STP" style='font-size:17px;'>STP</a>
	
		<a href="/tag.html#compiler" style='font-size:19px;'>compiler</a>
	
		<a href="/tag.html#yacc" style='font-size:17px;'>yacc</a>
	
		<a href="/tag.html#lex" style='font-size:17px;'>lex</a>
	
		<a href="/tag.html#life" style='font-size:19px;'>life</a>
	
		<a href="/tag.html#PVST" style='font-size:17px;'>PVST</a>
	
		<a href="/tag.html#FSD" style='font-size:17px;'>FSD</a>
	
		<a href="/tag.html#Programmer" style='font-size:17px;'>Programmer</a>
	
		<a href="/tag.html#PLY" style='font-size:17px;'>PLY</a>
	
		<a href="/tag.html#Python" style='font-size:17px;'>Python</a>
	
		<a href="/tag.html#Lex" style='font-size:17px;'>Lex</a>
	
		<a href="/tag.html#Yacc" style='font-size:17px;'>Yacc</a>
	
		<a href="/tag.html#grid" style='font-size:17px;'>grid</a>
	
		<a href="/tag.html#html5" style='font-size:17px;'>html5</a>
	
		<a href="/tag.html#video" style='font-size:17px;'>video</a>
	
		<a href="/tag.html#mp4" style='font-size:17px;'>mp4</a>
	
		<a href="/tag.html#webm" style='font-size:17px;'>webm</a>
	
		<a href="/tag.html#ogv" style='font-size:17px;'>ogv</a>
	
		<a href="/tag.html#javascript" style='font-size:21px;'>javascript</a>
	
		<a href="/tag.html#template" style='font-size:17px;'>template</a>
	
		<a href="/tag.html#Function" style='font-size:17px;'>Function</a>
	
		<a href="/tag.html#web-server" style='font-size:21px;'>web-server</a>
	
		<a href="/tag.html#nginx" style='font-size:23px;'>nginx</a>
	
		<a href="/tag.html#grunt" style='font-size:17px;'>grunt</a>
	
		<a href="/tag.html#docker" style='font-size:17px;'>docker</a>
	
		<a href="/tag.html#dockerfile" style='font-size:17px;'>dockerfile</a>
	
		<a href="/tag.html#Gitolite" style='font-size:19px;'>Gitolite</a>
	
		<a href="/tag.html#Hook" style='font-size:19px;'>Hook</a>
	
		<a href="/tag.html#backbone" style='font-size:21px;'>backbone</a>
	
		<a href="/tag.html#cloud" style='font-size:19px;'>cloud</a>
	
		<a href="/tag.html#markdown" style='font-size:17px;'>markdown</a>
	
		<a href="/tag.html#storage" style='font-size:23px;'>storage</a>
	
		<a href="/tag.html#disk" style='font-size:17px;'>disk</a>
	
		<a href="/tag.html#raid" style='font-size:17px;'>raid</a>
	
		<a href="/tag.html#VM" style='font-size:17px;'>VM</a>
	
		<a href="/tag.html#FileSystem" style='font-size:19px;'>FileSystem</a>
	
		<a href="/tag.html#CSS" style='font-size:17px;'>CSS</a>
	
		<a href="/tag.html#Web" style='font-size:17px;'>Web</a>
	
		<a href="/tag.html#sae" style='font-size:17px;'>sae</a>
	
		<a href="/tag.html#objective-c" style='font-size:19px;'>objective-c</a>
	
		<a href="/tag.html#ios" style='font-size:21px;'>ios</a>
	
		<a href="/tag.html#php" style='font-size:19px;'>php</a>
	
		<a href="/tag.html#memcache" style='font-size:17px;'>memcache</a>
	
		<a href="/tag.html#yii" style='font-size:19px;'>yii</a>
	
		<a href="/tag.html#phpunit" style='font-size:17px;'>phpunit</a>
	
		<a href="/tag.html#ssh" style='font-size:17px;'>ssh</a>
	
		<a href="/tag.html#rsync" style='font-size:17px;'>rsync</a>
	
		<a href="/tag.html#FastCGI" style='font-size:17px;'>FastCGI</a>
	
		<a href="/tag.html#lighttpd" style='font-size:17px;'>lighttpd</a>
	
		<a href="/tag.html#vim" style='font-size:17px;'>vim</a>
	
		<a href="/tag.html#hello world" style='font-size:17px;'>hello world</a>
	
</div>
<div class='foot text-center'>
	<p>Powered by</p><p><a href='https://github.com/'>Github</a> <a href='http://jekyllrb.com/'>jekyll</a> <a href="http://www.bootcss.com/">bootstrap</a> <a href="http://typo.sofi.sh/">typo.css</a> <a href="http://jekyllthemes.org/themes/dbyll/">Dbyll</a> <a href="http://disqus.com" class="dsq-brlink">Disqus</a>
    <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1258548781'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1258548781' type='text/javascript'%3E%3C/script%3E"));</script>
    </p>
</div>

	</div>

	<div class="col-sm-9 typo" style="background-color:#fff;">
		<div class="col-sm-8" style=" padding: 40px 0; "><div class="page-header">
  <h1>Remedy Mid-tier SSO </h1>
</div>
	
<article>

	<div class="col-sm-12">
  	<small>
	   
	   May 
	   14th,
	   
	   2013
	 </small>
	  <div class="article_body" id="article_body">
	  <p><code class="highlighter-rouge">SSO</code>（Single-Sign-On）单点登录，是指在一个网站中登录后能够无登录的以相同的身份访问另一个站点的资源。在之前的项目中遇到了如何在有Mid-tier的系统中实现SSO，这主要分为两种情况：</p>

<ul>
  <li>在非Mid-tier站点中登录后，无登录进入Mid-tier站点</li>
  <li>在Mid-tier站点登录后，无登录进入非Mid-tier站点</li>
</ul>

<p>由于Mid-tier几乎是个黑盒的产品，所以要实现SSO需要一些技巧，当然，本文提到方法只是可选的方案，仅供参考，安全方面的问题也不是本文讨论的重点。</p>

<h2 id="section">单点登录的基础问题（纯理论，可跳过）</h2>

<p>登录本质上是服务器端保持用户会话的行为，不同的web框架有不同的实现方式，但session这个概念似乎被广为接受，是一个专用名词了。session本质上需要跟cookie一起使用，才能在服务器端标识用户。</p>

<p>我们自底向上考虑这个问题，如果我们的多个站点能够共享session的话那么单点登录就十分容易了，典型的方式是将session保存在共享缓存（memcache）或者数据库中，具体的细节笔者没有实现过，所以不多提了。</p>

<p>其次，标准的SSO方案应该是包含一个第三方认证服务器的，这个服务器负责实现验证和鉴权，其他服务器都从这个服务器上获取用户登录信息，这个方式有些像上面这种共享session的方式，但是显然这种方式灵活度更大，但是成本也比较高，是一种标准的SSO方案：图片来源（<a href="http://www.cnblogs.com/yupeng/archive/2012/05/24/2517317.html">http://www.cnblogs.com/yupeng/archive/2012/05/24/2517317.html</a>）</p>

<p>上面两种方法看起来十分出色，但是实际上难以实现，因为SSO往往是一个系统集成的问题，系统在规划阶段不太可能考虑这样的需求，如果改造系统的话成本比较高。在现实的情况下，单点登录的问题可以认为就是跨域问题：</p>

<p>虽然cookie不能跨域（浏览器限制），但是如果两个站点在同一个父域内的话，利用cookie可以在父域中共享的特点可以实现SSO。cookie有一个Domain属性，很多web框架默认是写入当前域的，我们可以自己重载，写入父域。比如：A.company.com和站点B.company.com，用户登录A.company.com的时候将其登录信息写入cookie，并将Domain设置为*.company.com，这样B.company.com站点就可以看到这个cookie了。</p>

<p>如果不在同一个父域怎么解决呢？</p>

<p>流行的做法是利用iframe的src或者是<code class="highlighter-rouge">&lt;script&gt;</code>的src属性，现在流行的<code class="highlighter-rouge">JSONP</code>就是利用<code class="highlighter-rouge">script</code>的<code class="highlighter-rouge">src</code>可以“跨域”的特性，实现的ajax跨域。在实现单点登录的时候，也可以利用这一点。关于JSONP可以查看这里：<a href="http://www.cnblogs.com/dowinning/archive/2012/04/19/json-jsonp-jquery.html">【原创】说说JSON和JSONP，也许你会豁然开朗，含jQuery用例</a>。</p>

<p>另外，P3P在这里也扮演重要的角色。简单的说，假设你是从A.company.com访问B.company.com，也就是说Header的Referer不是当前域话，B.company.com无法在第一时间写入利用<code class="highlighter-rouge">Set Cookie</code>写入cookie，浏览器会认为这是不安全和不可靠的。但是利用P3P协议有时可以实现，但在浏览器兼容方面需要考虑很多。参考<a href="http://sjolzy.cn/PHP-Using-P3P-to-achieve-cross-domain.html">PHP - 利用P3P实现跨域</a></p>

<p>最近比较流行的<code class="highlighter-rouge">OAuth</code>也可以用来解决单点登录问题。</p>

<p>由于本文的重点不在这里，出于完整性的考虑补充到此。好，接下来进入正题。</p>

<h2 id="mid-tiermid-tier">在非Mid-tier站点中登录后，无登录进入Mid-tier站点</h2>

<p>BMC有一份关于<code class="highlighter-rouge">Mid-tier SSO</code>的文档<code class="highlighter-rouge">Integrating BMC Remedy Action Request System with Single Sign-On (SSO) </code>。要实现这一点就需要利用Mid-tier的这个特性。由于Mid-tier是<code class="highlighter-rouge">java</code>开发的，所以下面的代码跟java有关。</p>

<p>在Mid-tier的实现中有一个接口<code class="highlighter-rouge">com.remedy.arsys.session.Authenticator</code></p>

<p>该接口有如下方法：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="n">Map</span> <span class="n">cfg</span><span class="o">)</span>
<span class="n">UserCredentials</span> <span class="nf">getAuthenticatedCredentials</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">destroy</span><span class="p">(</span><span class="o">)</span></code></pre></figure>

<p>Mid-tier会在恰当的时候调用该接口的实现，以获取用户的登录信息<code class="highlighter-rouge">UserCredentials</code>，<code class="highlighter-rouge">UserCredentials</code>是一个保存有UserName、Password、AuthString的结构。然后，Mid-tier会将用这个把这个结构抛给AR认证，AR如何认证跟Mid-tier就没关系了。默认情况下，Mid-tier有一个<code class="highlighter-rouge">DefaultAuthenticator</code>的实现，这个实现就是从<code class="highlighter-rouge">HttpServletRequest</code>中获取特定键值对应的用户名和密码以及AuthString，然后构造<code class="highlighter-rouge">UserCredentials</code>并返回。这个键值可以是Form中的，也可以是QueryString中的，这也就是为什么通过在url上添加<code class="highlighter-rouge">username=&amp;pwd=</code>也可以登录的原因。如果在处理中出错或者无法获得合法的<code class="highlighter-rouge">UserCredentials</code>，会重定向到<code class="highlighter-rouge">login</code>页面。</p>

<p>既然核心的接口暴露出来了，那么假如我们重写这个实现，就可以避免使用键值的方式来获取登录信息，比如可以从cookie、Header中获取。也就是说，如果A.company.com的cookie可以被B.company.com（Mide-tier）获取，那么通过重写这个<code class="highlighter-rouge">Authenticator</code>就可以获取cookie中的用户信息，从而“欺骗”Mid-tier用户已经登录了。</p>

<p>但是接下来的问题是，由于<code class="highlighter-rouge">UserCredentials</code>会被传到AR端进行身份验证，所以需要保证“伪造”的这个UserCredentials能够通过AR验证。而在AR端，进行身份验证有多种方式，比如<code class="highlighter-rouge">LDAP</code>集成验证，或者AR的Form验证。而cookie一般不适合保存密码，所以构造的这个UserCredentials的时候也不能获得用户的密码，一般情况下可以设置一个所有用户都能通过验证的密码，简称“默认密码”。</p>

<p>因此，当AR是以Form验证方式设置的时候，这种方案就不可取了。但是仍然可以通过重写AR端的AREA认证模块来实现，但是在Mid-tier端的原理是一样的。下图归纳了上述过程，并给出了一种实现：</p>

<p><img src="/assets/img/2013-05-14-img2.png" alt="" /></p>

<p>上图为我们描述了下面的场景</p>

<ol>
  <li>浏览器访问Mid-tier前，设置HTTP basic Authentication，于是在访问Mid-tier时有<code class="highlighter-rouge">Authorization</code>头</li>
  <li>Mid-tier初步处理请求</li>
  <li>Mid-tier根据<code class="highlighter-rouge">config.properties</code>的配置加载<code class="highlighter-rouge">Authenticator</code>的一个自定义实现<code class="highlighter-rouge">SSOAuthenticator</code></li>
  <li><code class="highlighter-rouge">SSOAuthenticator</code>根据<code class="highlighter-rouge">Authorization</code>头和<code class="highlighter-rouge">sso.properties</code>的配置信息，构造<code class="highlighter-rouge">UserCredentials</code>传给<code class="highlighter-rouge">AR</code>，这个<code class="highlighter-rouge">UserCredentials</code>用了一个固定的密码</li>
  <li>由于AR在<code class="highlighter-rouge">arconfig</code>中配置了用<code class="highlighter-rouge">AREA</code>认证，而且启用了<code class="highlighter-rouge">ARhub</code>模式，所以优先用一个自定义的<code class="highlighter-rouge">AREA SSO Plugin</code></li>
  <li>这个<code class="highlighter-rouge">AREA SSO Plugin</code>根据<code class="highlighter-rouge">areasso.cfg</code>中的配置验证Mid-tier的IP是否是白名单，并验证密码<code class="highlighter-rouge">是否是固定密码</code></li>
  <li>如果SSO认证失败，则由于hub的作用，继续通过<code class="highlighter-rouge">AREA LDAP Plugin</code>认证</li>
  <li>AR验证这个用户是否系统用户还是访客</li>
</ol>

<p>接下来根据上述实现给出核心代码，主要是Mid-tier端<code class="highlighter-rouge">SSOAuthenticator</code>的代码</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">remedy</span><span class="o">.</span><span class="na">arsys</span><span class="o">.</span><span class="na">sso</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.remedy.arsys.session.Authenticator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.remedy.arsys.session.UserCredentials</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="c1">//import java.net.*;</span>
<span class="kn">import</span> <span class="nn">com.remedy.arsys.log.Log</span><span class="o">;</span>



<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SSOAuthenticator</span> <span class="kd">implements</span> <span class="n">Authenticator</span>
<span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="n">init</span><span class="o">(</span><span class="n">Map</span> <span class="n">cfg</span><span class="o">)</span>
    <span class="o">{</span>
    <span class="err">…</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="n">destroy</span><span class="o">()</span>
    <span class="o">{</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="n">UserCredentials</span> <span class="n">getAuthenticatedCredentials</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
        <span class="c1">// Use getRemoteuser call to get username</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">usermethod</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">usermethod</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"remoteuser"</span><span class="o">))</span>
        <span class="o">{</span>
            <span class="n">String</span> <span class="n">remoteUser</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRemoteUser</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">remoteUser</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">remoteUser</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">""</span><span class="o">))</span>
            <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">debug</span><span class="o">){</span>
                    <span class="n">mtLog</span><span class="o">.</span><span class="na">fine</span><span class="o">(</span><span class="s">"SSO: Remote User Name (including domain): "</span><span class="o">+</span> <span class="n">remoteUser</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="c1">// Use removedomain to parse domain name from getRemoteUser call</span>
                <span class="k">if</span><span class="o">(</span><span class="n">removedomain</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">removedomain</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"T"</span><span class="o">))</span>
                <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">startpoint</span> <span class="o">=</span> <span class="n">remoteUser</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"\\"</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="kt">int</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="n">remoteUser</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
                    <span class="n">String</span> <span class="n">rUserNoDomain</span> <span class="o">=</span> <span class="n">remoteUser</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">startpoint</span><span class="o">,</span> <span class="n">endpoint</span><span class="o">);</span>
                    <span class="c1">//remoteUser = remoteUser.substring(startpoint, endpoint);</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">debug</span><span class="o">){</span>
                        <span class="n">mtLog</span><span class="o">.</span><span class="na">fine</span><span class="o">(</span><span class="s">"SSO: Remote User Name (no domain): "</span><span class="o">+</span> <span class="n">rUserNoDomain</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">username</span> <span class="o">=</span> <span class="n">rUserNoDomain</span><span class="o">;</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="n">UserCredentials</span><span class="o">(</span><span class="n">getUserName</span><span class="o">(</span><span class="n">username</span><span class="o">),</span> <span class="n">PASS_STRING</span><span class="o">,</span> <span class="n">getAuthString</span><span class="o">(</span><span class="n">remoteUser</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="k">else</span>
                <span class="o">{</span>
                    <span class="n">username</span> <span class="o">=</span> <span class="n">remoteUser</span><span class="o">;</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="n">UserCredentials</span><span class="o">(</span><span class="n">getUserName</span><span class="o">(</span><span class="n">username</span><span class="o">),</span> <span class="n">PASS_STRING</span><span class="o">,</span> <span class="n">getAuthString</span><span class="o">(</span><span class="n">remoteUser</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">else</span>
            <span class="o">{</span>
                <span class="n">mtLog</span><span class="o">.</span><span class="na">fine</span><span class="o">(</span><span class="s">"SSO ERROR: RemoteUser name is null or empty. Using default login page"</span><span class="o">);</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">UserCredentials</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">else</span>
        <span class="o">{</span>
            <span class="c1">// No setting (in sso.properties) was provided to get the username</span>
            <span class="n">mtLog</span><span class="o">.</span><span class="na">fine</span><span class="o">(</span><span class="s">"SSO ERROR: No valid method defined in sso.properties to get username. Using default login page"</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">UserCredentials</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>在部署的时候，将代码编译打包成jar，复制到Mid-tier的<code class="highlighter-rouge">WEB-INF\lib</code>目录下，修改Mid-tier的<code class="highlighter-rouge">config.properties</code>配置文件，将</p>

<p><code class="highlighter-rouge">arsystem.authenticator=com.remedy.arsys.session.DefaultAuthenticator</code>改为<code class="highlighter-rouge">arsystem.authenticator=com.remedy.arsys.sso.SSOAuthenticator</code>，这样Mid-tier在实例化接口时能用自定义的实现</p>

<p>另外，Init方法传入的Map对象，是Mid-tier为这个接口实现预留的配置文件入口，可以通过配置<code class="highlighter-rouge">config.propertie</code>s的<code class="highlighter-rouge">arsystem.authenticator.config.file=XXX.properties</code>中来指定，而配置文件需要复制到<code class="highlighter-rouge">WEB-INF\classes</code>目录下。</p>

<p>上述实现在AR端也需要一个自定义的AREA Plug-in，代码可以在最后的下载链接中下载。不过需要说明的是笔者并没有仔细对这个AREA Plug-in进行测试，而且这种方案较为复杂，慎用。简单起见还是用cookie和配置所有用户为同一个form密码来做比较保险。</p>

<h2 id="mid-tiermid-tier-1">在Mid-tier站点登录后，无登录进入非Mid-tier站点</h2>

<p>这种情况相对来说处理简单些，因为非Mid-tier站点一般是自定义开发的，所以有比较大的灵活度。我所采用的方法是这样的：</p>

<p><img src="/assets/img/2013-05-14-img1.png" alt="" /></p>

<ul>
  <li>在Mid-tier端放置一个<code class="highlighter-rouge">jsp</code>文件，首先通过链接引导用户访问这个jsp，这个文件通过<code class="highlighter-rouge">UserCredentials</code>对象获取当前登录人的<code class="highlighter-rouge">User</code></li>
</ul>

<figure class="highlight"><pre><code class="language-jsp" data-lang="jsp">&lt;%@ page import="com.remedy.arsys.session.*" %&gt;
&lt;%
String user = "";
Object obj = session.getAttribute("usercredentials");
if (obj == null) {
        response.sendRedirect("login.jsp"); 
}else{
        UserCredentials usercredentials = (UserCredentials)obj;
        user = usercredentials.getUser();
}
%&gt; </code></pre></figure>

<ul>
  <li>返回一段带有脚本的页面，该脚本将自动向非Mid-tier站点post数据，并能够带上UserName</li>
  <li>用户获取到这个页面后，浏览器自动post非Mid-tier站点</li>
  <li>非Mid-tier站点在post的数据域中检测到登录用户名，将之存在session中，表示登录</li>
  <li>处理程序返回页面，此时，用户已在非Mid-tier中登录，以后的访问都将是登录后的访问</li>
</ul>

<p>为了安全起见，可以对这个机制稍作强化：在2步中可以将用户名加密返回，加密机制可以适当的强化；在第4步中，可以重复验证一下，用户是否是合法用户。</p>

<p><a href="/assets/download/sso.zip">代码下载</a></p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/category.html#BMC">
					BMC <span>(8)</span>
					,
				</a></li>
			 
				<li><a href="/category.html#Web">
					Web <span>(5)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tag.html#BMC">
					BMC <span>(6)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tag.html#Mid-Tier">
					Mid-Tier <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tag.html#Remedy">
					Remedy <span>(7)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tag.html#SSO">
					SSO <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <!-- JiaThis Button BEGIN -->
		<div class="jiathis_style">
			<a class="jiathis_button_tsina"></a>
			<a class="jiathis_button_tqq"></a>
			<a class="jiathis_button_weixin"></a>
			<a class="jiathis_button_renren"></a>
			<a class="jiathis_button_douban"></a>
			<a class="jiathis_button_fb"></a>
			<a class="jiathis_button_twitter"></a>
			<a class="jiathis_button_evernote"></a>
			<a class="jiathis_button_qzone"></a>
			<a class="jiathis_button_ydnote"></a>
			<a class="jiathis_button_linkedin"></a>
			<a href="http://www.jiathis.com/share?uid=1900073" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
			<a class="jiathis_counter_style"></a>
		</div>
		<script type="text/javascript">
		var jiathis_config = {data_track_clickback:'true'};
		</script>
		<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=1900073" charset="utf-8"></script>
		<!-- JiaThis Button END -->
      </section>

      <section class="col-sm-6 author">

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/bmc/network/2013/05/05/bmc-portmapper-detail.html" title="从BMC AR Portmapper展开说去">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/bmc/2013/07/17/remedy-approval-server-concept.html" title="BMC Remedy 审批引擎-概述与设计">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
<!-- 	<div class="col-sm-2 sidebar-2">
	
	</div> -->
	<div id="disqus_thread"></div>
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'pchou'; // required: replace example with your forum shortname

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


 <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'pchou'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
</article>

<div class="clearfix"></div>

</div>
			<div class="col-sm-4 hidden-xs typo" style=" padding-top: 90px; ">
		<h4>扫一扫，手机阅读</h4>
		<div class='qrcode'></div>

		<div id="sideBar">
		</div>

	</div>

	</div>


	<script src="http://cdn.bootcss.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
	<script src="http://cdn.bootcss.com/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/stick.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>

